<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Admin panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sidebar {
            background-color: #f8f9fa;
            height: 100vh;
            padding: 0;
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
        }
        .user-role-badge {
            background-color: #6c757d;
            color: white;
            padding: 0.25em 0.4em;
            border-radius: 0.25rem;
            font-size: 0.875em;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <span class="navbar-text text-white">
            <strong id="currentUsername">Loading...</strong>
            with roles: <span id="currentUserRoles">Loading...</span>
        </span>
        <form action="/logout" method="post" class="d-inline">
            <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
            <button type="submit" class="btn btn-outline-light btn-sm">Logout</button>
        </form>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-2 sidebar">
            <ul class="nav flex-column nav-pills p-2">
                <li class="nav-item mb-2">
                    <a class="nav-link active" href="/admin">Admin</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/user">User</a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="col-10 mt-3">
            <h2>Admin panel</h2>

            <!-- Tabs -->
            <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="users-tab" data-bs-toggle="tab"
                            data-bs-target="#usersTable" type="button">Users table</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="newuser-tab" data-bs-toggle="tab"
                            data-bs-target="#newUserForm" type="button">New User</button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Users table -->
                <div class="tab-pane fade show active" id="usersTable">
                    <h4>All users</h4>
                    <div id="loadingSpinner" class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <table class="table table-striped align-middle" id="usersTableContent" style="display: none;">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Roles</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="usersTableBody">
                        </tbody>
                    </table>
                    <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
                </div>

                <!-- New user -->
                <div class="tab-pane fade" id="newUserForm">
                    <h4>Add new user</h4>
                    <form id="newUserFormElement" class="w-50">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" id="newUsername" name="username" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" id="newPassword" name="password" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="newEmail" name="email" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Roles:</label>
                            <div id="rolesContainer">
                                <!-- Роли будут загружены через JavaScript -->
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Add new user</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editUserForm">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editId" name="id">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" name="username" id="editUsername" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" id="editEmail" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password (leave empty to keep current)</label>
                        <input type="password" name="password" id="editPassword" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Roles</label>
                        <div id="editRolesContainer">
                            <!-- Роли будут загружены через JavaScript -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete user: <strong id="deleteUsername"></strong>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast для уведомлений -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Конфигурация API
    const API_BASE = '/api';
    let currentDeleteUserId = null;
    let availableRoles = [];

    // Загрузка данных при старте
    document.addEventListener('DOMContentLoaded', function() {
        loadCurrentUser();
        loadUsers();
        loadRoles();

        // Обработчики форм
        document.getElementById('newUserFormElement').addEventListener('submit', handleCreateUser);
        document.getElementById('editUserForm').addEventListener('submit', handleUpdateUser);
        document.getElementById('confirmDelete').addEventListener('click', handleDeleteUser);
    });

    // Загрузка текущего пользователя
    async function loadCurrentUser() {
        try {
            const response = await fetch(`${API_BASE}/user/current`);
            if (!response.ok) throw new Error('Failed to load current user');

            const user = await response.json();
            document.getElementById('currentUsername').textContent = user.username;
            document.getElementById('currentUserRoles').textContent =
                Array.from(user.roles).map(role => role.replace('ROLE_', '')).join(', ');
        } catch (error) {
            showError('Failed to load current user: ' + error.message);
        }
    }

    // Загрузка списка пользователей
    async function loadUsers() {
        showLoading();
        try {
            const response = await fetch(`${API_BASE}/admin/users`);
            if (!response.ok) throw new Error('Failed to load users');

            const users = await response.json();
            renderUsersTable(users);
            hideLoading();
        } catch (error) {
            hideLoading();
            showError('Failed to load users: ' + error.message);
        }
    }

    // Загрузка доступных ролей
    async function loadRoles() {
        try {
            // В реальном приложении здесь был бы API endpoint для ролей
            // Для демонстрации используем статические данные или загружаем с сервера
            availableRoles = [
                { id: 1, name: 'ROLE_ADMIN' },
                { id: 2, name: 'ROLE_USER' }
            ];
            renderRoleCheckboxes();
        } catch (error) {
            showError('Failed to load roles: ' + error.message);
        }
    }

    // Рендеринг таблицы пользователей
    function renderUsersTable(users) {
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';

        users.forEach(user => {
            const row = document.createElement('tr');
            const rolesDisplay = Array.from(user.roles).map(role =>
                `<span class="user-role-badge">${role.replace('ROLE_', '')}</span>`
            ).join(' ');

            row.innerHTML = `
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${user.email}</td>
                <td>${rolesDisplay}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-info edit-btn"
                                data-user='${JSON.stringify(user).replace(/'/g, "&apos;")}'>
                            Edit
                        </button>
                        <button type="button" class="btn btn-danger delete-btn"
                                data-id="${user.id}" data-username="${user.username}">
                            Delete
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });

        // Добавляем обработчики для кнопок
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', handleEditClick);
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', handleDeleteClick);
        });

        document.getElementById('usersTableContent').style.display = 'table';
    }

    // Рендеринг чекбоксов ролей
    function renderRoleCheckboxes() {
        const newUserContainer = document.getElementById('rolesContainer');
        const editContainer = document.getElementById('editRolesContainer');

        newUserContainer.innerHTML = '';
        editContainer.innerHTML = '';

        availableRoles.forEach(role => {
            const displayName = role.name.replace('ROLE_', '');

            // Для формы создания
            const newCheckbox = document.createElement('div');
            newCheckbox.className = 'form-check';
            newCheckbox.innerHTML = `
                <input class="form-check-input" type="checkbox" value="${role.name}"
                       id="newRole_${role.id}" name="roles">
                <label class="form-check-label" for="newRole_${role.id}">
                    ${displayName}
                </label>
            `;
            newUserContainer.appendChild(newCheckbox);

            // Для формы редактирования
            const editCheckbox = document.createElement('div');
            editCheckbox.className = 'form-check';
            editCheckbox.innerHTML = `
                <input class="form-check-input" type="checkbox" value="${role.name}"
                       id="editRole_${role.id}" name="roles">
                <label class="form-check-label" for="editRole_${role.id}">
                    ${displayName}
                </label>
            `;
            editContainer.appendChild(editCheckbox);
        });
    }

    // Обработчики событий
    function handleEditClick(event) {
        const userData = JSON.parse(event.target.getAttribute('data-user').replace(/&apos;/g, "'"));
        openEditModal(userData);
    }

    function handleDeleteClick(event) {
        const userId = event.target.getAttribute('data-id');
        const username = event.target.getAttribute('data-username');
        openDeleteModal(userId, username);
    }

    function openEditModal(user) {
        document.getElementById('editId').value = user.id;
        document.getElementById('editUsername').value = user.username;
        document.getElementById('editEmail').value = user.email;
        document.getElementById('editPassword').value = '';

        // Сбрасываем чекбоксы
        document.querySelectorAll('#editRolesContainer input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
        });

        // Устанавливаем текущие роли пользователя
        user.roles.forEach(role => {
            const checkbox = document.querySelector(`#editRolesContainer input[value="${role}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });

        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();
    }

    function openDeleteModal(userId, username) {
        currentDeleteUserId = userId;
        document.getElementById('deleteUsername').textContent = username;
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }

    // Обработчики форм
    async function handleCreateUser(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const userData = {
            username: document.getElementById('newUsername').value,
            password: document.getElementById('newPassword').value,
            email: document.getElementById('newEmail').value,
            roles: Array.from(document.querySelectorAll('#rolesContainer input[type="checkbox"]:checked'))
                      .map(checkbox => checkbox.value)
        };

        try {
            const response = await fetch(`${API_BASE}/admin/users`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to create user');
            }

            await loadUsers(); // Перезагружаем таблицу
            event.target.reset(); // Очищаем форму

            // Сбрасываем чекбоксы ролей
            document.querySelectorAll('#rolesContainer input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });

            showSuccess('User created successfully!');

            // Переключаемся на вкладку с таблицей пользователей
            activateTab('users-tab', 'usersTable');

        } catch (error) {
            showError('Failed to create user: ' + error.message);
        }
    }

    async function handleUpdateUser(event) {
        event.preventDefault();

        const userId = document.getElementById('editId').value;
        const userData = {
            id: parseInt(userId),
            username: document.getElementById('editUsername').value,
            email: document.getElementById('editEmail').value,
            roles: Array.from(document.querySelectorAll('#editRolesContainer input[type="checkbox"]:checked'))
                      .map(checkbox => checkbox.value)
        };

        // Добавляем пароль только если он указан
        const password = document.getElementById('editPassword').value;
        if (password) {
            userData.password = password;
        }

        try {
            const response = await fetch(`${API_BASE}/admin/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to update user');
            }

            await loadUsers(); // Перезагружаем таблицу

            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
            modal.hide();

            showSuccess('User updated successfully!');

        } catch (error) {
            showError('Failed to update user: ' + error.message);
        }
    }

    async function handleDeleteUser() {
        if (!currentDeleteUserId) return;

        try {
            const response = await fetch(`${API_BASE}/admin/users/${currentDeleteUserId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to delete user');
            }

            await loadUsers(); // Перезагружаем таблицу

            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();

            showSuccess('User deleted successfully!');
            currentDeleteUserId = null;

        } catch (error) {
            showError('Failed to delete user: ' + error.message);
        }
    }

    // Вспомогательные функции
    function showLoading() {
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('usersTableContent').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'none';
    }

    function hideLoading() {
        document.getElementById('loadingSpinner').style.display = 'none';
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        document.getElementById('usersTableContent').style.display = 'none';
        document.getElementById('loadingSpinner').style.display = 'none';
    }

    function showSuccess(message) {
        const toastEl = document.getElementById('successToast');
        const toastMessage = document.getElementById('toastMessage');

        if (toastEl && toastMessage) {
            toastMessage.textContent = message;
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        } else {
            // Fallback на простой alert
            alert(message);
        }
    }

    function activateTab(tabId, paneId) {
        // Деактивируем все вкладки
        document.querySelectorAll('.nav-link').forEach(tab => {
            tab.classList.remove('active');
        });

        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('show', 'active');
        });

        // Активируем нужную вкладку
        document.getElementById(tabId).classList.add('active');
        document.getElementById(paneId).classList.add('show', 'active');
    }

    // Функция для переключения вкладок через Bootstrap
    function switchToTab(tabName) {
        const tabTrigger = document.querySelector(`#${tabName}-tab`);
        if (tabTrigger) {
            bootstrap.Tab.getInstance(tabTrigger).show();
        }
    }
</script>
</body>
</html>